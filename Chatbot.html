<div style="max-width:600px;margin:auto;padding:20px;">
    <h2>üì± AbbasPhone Bot</h2>
    <textarea id="userInput" rows="3" style="width:100%;padding:8px;" placeholder="Ask me about our phones‚Ä¶"></textarea>
    <button id="sendBtn" style="background:#ff5722; color:#fff; padding:0.8rem 1.2rem;
      text-decoration:none; border-radius:4px;
      transition:background .3s;">Send</button>
    <div id="chatOutput" style="margin-top:16px;border:1px solid #ccc;padding:12px;border-radius:6px;min-height:80px;"></div>
  </div>
  
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- 1) Init Firebase ---
      firebase.initializeApp({
        apiKey:    "AIzaSyAMuEPDrZj-VTyzNRv22stBpm3UjAG9PSo",
        authDomain:"abbasphone.firebaseapp.com",
        projectId: "abbasphone"
      });
      const db = firebase.firestore();
  
      // --- 2) Helper: pull your phones from Firestore ---
      async function loadPhones() {
        const snap = await db.collection("phones").get();
        return snap.docs.map(d => d.data())
          .map(p=>`${p.name} ‚Äî $${p.price}, stock: ${p.stock}`)
          .join('\n');
      }
  
      // --- 3) Chat handler ---
      const sendBtn   = document.getElementById('sendBtn');
      const inputEl   = document.getElementById('userInput');
      const outputEl  = document.getElementById('chatOutput');
  
      sendBtn.addEventListener('click', async () => {
        const question = inputEl.value.trim();
        if (!question) return;
        outputEl.innerHTML = '<em>Thinking‚Ä¶</em>';
  
        try {
          // 3a) fetch current phone list
          const phoneListText = await loadPhones();
  
          // 3b) build your messages
          const messages = [
            { role: 'system', content:
                `You are AbbasPhone‚Äôs helpful assistant.  
                 Here is the current inventory (one per line):  
                 ${phoneListText}`
            },
            { role: 'user', content: question }
          ];
  
          // 3c) call OpenAI
          const res = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type':'application/json',
              'Authorization':'Bearer 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'
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages
            })
          });
  
          // Log the entire response for debugging
          const data = await res.json();
          console.log('API Response:', data);
  
          // 3d) Check if 'choices' exists before using it
          if (data.choices && data.choices.length > 0) {
            outputEl.innerHTML = `<b>Bot:</b> ${data.choices[0].message.content}`;
          } else {
            outputEl.innerHTML = "‚ùå No response from AI.";
          }
        } catch (err) {
          console.error('Error:', err);
          outputEl.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
        }
      });
    });
  </script>